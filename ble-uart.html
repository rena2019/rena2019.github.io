<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Nordic UART Console (Web Bluetooth)</title>
  <style>
    body {
      font-family: monospace;
      background: #111;
      color: #0f0;
      padding: 20px;
    }
    textarea {
      width: 100%;
      height: 300px;
      background: #000;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 10px;
      resize: none;
    }
    button {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<button id="connect">Connect BLE</button><br><br>
<textarea id="console" disabled></textarea>

<script type="module">
/* Nordic UART UUIDs */
const NUS_SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const NUS_RX      = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write
const NUS_TX      = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify

const textarea = document.getElementById("console");
const encoder = new TextEncoder();
const decoder = new TextDecoder("utf-8", { fatal: false });

let rxChar = null;
let lastLength = 0;
let suppressInput = false;

/* ðŸ”Œ CONNECT â€” USER GESTURE SAFE */
document.getElementById("connect").addEventListener("click", async () => {
  try {
    const device = await navigator.bluetooth.requestDevice({
      filters: [
        { namePrefix: 'mpy-uart' }
      ],
      optionalServices: [NUS_SERVICE] // ðŸ‘ˆ wichtig!
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(NUS_SERVICE);

    rxChar = await service.getCharacteristic(NUS_RX);
    const txChar = await service.getCharacteristic(NUS_TX);

    await txChar.startNotifications();
    txChar.addEventListener("characteristicvaluechanged", e => {
      // DataView â†’ Uint8Array â†’ Text
      const bytes = new Uint8Array(e.target.value.buffer);
      const text = decoder.decode(bytes, { stream: true });

      suppressInput = true;
      textarea.value += text;
      textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
      lastLength = textarea.value.length;
      suppressInput = false;
    });

    textarea.disabled = false;
    textarea.focus();
    textarea.value += "[connected]\n";
    lastLength = textarea.value.length;

  } catch (err) {
    console.error(err);
    alert("BLE error: " + err);
  }
});

/* âŒ¨ï¸ KEYSTROKES â†’ UART */
textarea.addEventListener("input", async () => {
  if (!rxChar || suppressInput) return;

  const value = textarea.value;
  const diff = value.slice(lastLength);
  lastLength = value.length;

  if (diff.length > 0) {
    try {
      await rxChar.writeValue(encoder.encode(diff));
    } catch (e) {
      console.error("Write error", e);
    }
  }
});
</script>

</body>
</html>


