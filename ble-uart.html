<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Nordic UART Console (Web Bluetooth)</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #111;
      color: #0f0;
    }
    textarea {
      width: 100%;
      height: 300px;
      background: #000;
      color: #0f0;
      font-size: 14px;
      border: 1px solid #0f0;
      padding: 10px;
      resize: none;
    }
    button {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<button id="connect">Connect BLE</button>
<br><br>

<textarea id="console" disabled></textarea>

<script type="module">
const NUS_SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const NUS_RX      = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write
const NUS_TX      = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify

const textarea = document.getElementById("console");
const encoder = new TextEncoder();
const decoder = new TextDecoder();

let rxChar;
let suppressInput = false; // verhindert Echo-Loops

// ðŸ”Œ Connect
document.getElementById("connect").addEventListener("click", async () => {
  const device = await navigator.bluetooth.requestDevice({
    filters: [{ namePrefix: 'mpy-uart' /* services: [NUS_SERVICE]*/  }]
  });

  const server = await device.gatt.connect();
  const service = await server.getPrimaryService(NUS_SERVICE);

  rxChar = await service.getCharacteristic(NUS_RX);
  const txChar = await service.getCharacteristic(NUS_TX);

  await txChar.startNotifications();
  txChar.addEventListener("characteristicvaluechanged", e => {
    const text = decoder.decode(e.target.value);

    suppressInput = true;
    textarea.value += text;
    textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
    suppressInput = false;
  });

  textarea.disabled = false;
  textarea.focus();
});

// âŒ¨ï¸ Tasten senden (nur neue Zeichen!)
let lastLength = 0;

textarea.addEventListener("input", async () => {
  if (!rxChar || suppressInput) return;

  const value = textarea.value;
  const diff = value.slice(lastLength);
  lastLength = value.length;

  if (diff.length > 0) {
    await rxChar.writeValue(encoder.encode(diff));
  }
});
</script>

</body>
</html>


